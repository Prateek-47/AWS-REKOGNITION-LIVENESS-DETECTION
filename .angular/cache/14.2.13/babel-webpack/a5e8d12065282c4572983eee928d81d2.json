{"ast":null,"code":"import { __assign, __awaiter, __generator, __read, __rest } from \"tslib\";\nimport { ModelPredicateCreator } from '../predicates';\nimport { QueryOne } from '../types';\nimport { USER, SYNC, valuesEqual } from '../util';\nimport { getIdentifierValue, TransformerMutationType } from './utils'; // TODO: Persist deleted ids\n// https://github.com/aws-amplify/amplify-js/blob/datastore-docs/packages/datastore/docs/sync-engine.md#outbox\n\nvar MutationEventOutbox =\n/** @class */\nfunction () {\n  function MutationEventOutbox(schema, MutationEvent, modelInstanceCreator, ownSymbol) {\n    this.schema = schema;\n    this.MutationEvent = MutationEvent;\n    this.modelInstanceCreator = modelInstanceCreator;\n    this.ownSymbol = ownSymbol;\n  }\n\n  MutationEventOutbox.prototype.enqueue = function (storage, mutationEvent) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , storage.runExclusive(function (s) {\n              return __awaiter(_this, void 0, void 0, function () {\n                var mutationEventModelDefinition, predicate, _a, first, incomingMutationType, merged_1, incomingConditionJSON, incomingCondition, merged;\n\n                return __generator(this, function (_b) {\n                  switch (_b.label) {\n                    case 0:\n                      mutationEventModelDefinition = this.schema.namespaces[SYNC].models['MutationEvent'];\n                      predicate = ModelPredicateCreator.createFromAST(mutationEventModelDefinition, {\n                        and: [{\n                          modelId: {\n                            eq: mutationEvent.modelId\n                          }\n                        }, {\n                          id: {\n                            ne: this.inProgressMutationEventId\n                          }\n                        }]\n                      });\n                      return [4\n                      /*yield*/\n                      , s.query(this.MutationEvent, predicate)];\n\n                    case 1:\n                      _a = __read.apply(void 0, [_b.sent(), 1]), first = _a[0];\n                      if (!(first === undefined)) return [3\n                      /*break*/\n                      , 3];\n                      return [4\n                      /*yield*/\n                      , s.save(mutationEvent, undefined, this.ownSymbol)];\n\n                    case 2:\n                      _b.sent();\n\n                      return [2\n                      /*return*/\n                      ];\n\n                    case 3:\n                      incomingMutationType = mutationEvent.operation;\n                      if (!(first.operation === TransformerMutationType.CREATE)) return [3\n                      /*break*/\n                      , 8];\n                      if (!(incomingMutationType === TransformerMutationType.DELETE)) return [3\n                      /*break*/\n                      , 5];\n                      return [4\n                      /*yield*/\n                      , s.delete(this.MutationEvent, predicate)];\n\n                    case 4:\n                      _b.sent();\n\n                      return [3\n                      /*break*/\n                      , 7];\n\n                    case 5:\n                      merged_1 = this.mergeUserFields(first, mutationEvent);\n                      return [4\n                      /*yield*/\n                      , s.save(this.MutationEvent.copyOf(first, function (draft) {\n                        draft.data = merged_1.data;\n                      }), undefined, this.ownSymbol)];\n\n                    case 6:\n                      _b.sent();\n\n                      _b.label = 7;\n\n                    case 7:\n                      return [3\n                      /*break*/\n                      , 12];\n\n                    case 8:\n                      incomingConditionJSON = mutationEvent.condition;\n                      incomingCondition = JSON.parse(incomingConditionJSON);\n                      merged = void 0;\n                      if (!(Object.keys(incomingCondition).length === 0)) return [3\n                      /*break*/\n                      , 10];\n                      merged = this.mergeUserFields(first, mutationEvent); // delete all for model\n\n                      return [4\n                      /*yield*/\n                      , s.delete(this.MutationEvent, predicate)];\n\n                    case 9:\n                      // delete all for model\n                      _b.sent();\n\n                      _b.label = 10;\n\n                    case 10:\n                      merged = merged || mutationEvent; // Enqueue new one\n\n                      return [4\n                      /*yield*/\n                      , s.save(merged, undefined, this.ownSymbol)];\n\n                    case 11:\n                      // Enqueue new one\n                      _b.sent();\n\n                      _b.label = 12;\n\n                    case 12:\n                      return [2\n                      /*return*/\n                      ];\n                  }\n                });\n              });\n            })];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  MutationEventOutbox.prototype.dequeue = function (storage, record, recordOp) {\n    return __awaiter(this, void 0, void 0, function () {\n      var head;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.peek(storage)];\n\n          case 1:\n            head = _a.sent();\n            if (!record) return [3\n            /*break*/\n            , 3];\n            return [4\n            /*yield*/\n            , this.syncOutboxVersionsOnDequeue(storage, record, head, recordOp)];\n\n          case 2:\n            _a.sent();\n\n            _a.label = 3;\n\n          case 3:\n            return [4\n            /*yield*/\n            , storage.delete(head)];\n\n          case 4:\n            _a.sent();\n\n            this.inProgressMutationEventId = undefined;\n            return [2\n            /*return*/\n            , head];\n        }\n      });\n    });\n  };\n  /**\n   * Doing a peek() implies that the mutation goes \"inProgress\"\n   *\n   * @param storage\n   */\n\n\n  MutationEventOutbox.prototype.peek = function (storage) {\n    return __awaiter(this, void 0, void 0, function () {\n      var head;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , storage.queryOne(this.MutationEvent, QueryOne.FIRST)];\n\n          case 1:\n            head = _a.sent();\n            this.inProgressMutationEventId = head ? head.id : undefined;\n            return [2\n            /*return*/\n            , head];\n        }\n      });\n    });\n  };\n\n  MutationEventOutbox.prototype.getForModel = function (storage, model, userModelDefinition) {\n    return __awaiter(this, void 0, void 0, function () {\n      var mutationEventModelDefinition, modelId, mutationEvents;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            mutationEventModelDefinition = this.schema.namespaces[SYNC].models.MutationEvent;\n            modelId = getIdentifierValue(userModelDefinition, model);\n            return [4\n            /*yield*/\n            , storage.query(this.MutationEvent, ModelPredicateCreator.createFromAST(mutationEventModelDefinition, {\n              and: {\n                modelId: {\n                  eq: modelId\n                }\n              }\n            }))];\n\n          case 1:\n            mutationEvents = _a.sent();\n            return [2\n            /*return*/\n            , mutationEvents];\n        }\n      });\n    });\n  };\n\n  MutationEventOutbox.prototype.getModelIds = function (storage) {\n    return __awaiter(this, void 0, void 0, function () {\n      var mutationEvents, result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , storage.query(this.MutationEvent)];\n\n          case 1:\n            mutationEvents = _a.sent();\n            result = new Set();\n            mutationEvents.forEach(function (_a) {\n              var modelId = _a.modelId;\n              return result.add(modelId);\n            });\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  }; // applies _version from the AppSync mutation response to other items\n  // in the mutation queue with the same id\n  // see https://github.com/aws-amplify/amplify-js/pull/7354 for more details\n\n\n  MutationEventOutbox.prototype.syncOutboxVersionsOnDequeue = function (storage, record, head, recordOp) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _version, _lastChangedAt, _deleted, _incomingData, incomingData, data, __version, __lastChangedAt, __deleted, _outgoingData, outgoingData, mutationEventModelDefinition, userModelDefinition, recordId, predicate, outdatedMutations, reconciledMutations;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (head.operation !== recordOp) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            _version = record._version, _lastChangedAt = record._lastChangedAt, _deleted = record._deleted, _incomingData = __rest(record, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n            incomingData = this.removeTimestampFields(head.model, _incomingData);\n            data = JSON.parse(head.data);\n\n            if (!data) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            __version = data._version, __lastChangedAt = data._lastChangedAt, __deleted = data._deleted, _outgoingData = __rest(data, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n            outgoingData = this.removeTimestampFields(head.model, _outgoingData); // Don't sync the version when the data in the response does not match the data\n            // in the request, i.e., when there's a handled conflict\n            //\n            // NOTE: `incomingData` contains all the fields in the record, and `outgoingData`\n            // only contains updated fields, resulting in an error when doing a comparison\n            // of two equal mutations. Fix this, or mitigate otherwise.\n\n            if (!valuesEqual(incomingData, outgoingData, true)) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            mutationEventModelDefinition = this.schema.namespaces[SYNC].models['MutationEvent'];\n            userModelDefinition = this.schema.namespaces['user'].models[head.model];\n            recordId = getIdentifierValue(userModelDefinition, record);\n            predicate = ModelPredicateCreator.createFromAST(mutationEventModelDefinition, {\n              and: [{\n                modelId: {\n                  eq: recordId\n                }\n              }, {\n                id: {\n                  ne: this.inProgressMutationEventId\n                }\n              }]\n            });\n            return [4\n            /*yield*/\n            , storage.query(this.MutationEvent, predicate)];\n\n          case 1:\n            outdatedMutations = _a.sent();\n\n            if (!outdatedMutations.length) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            reconciledMutations = outdatedMutations.map(function (m) {\n              var oldData = JSON.parse(m.data);\n\n              var newData = __assign(__assign({}, oldData), {\n                _version: _version,\n                _lastChangedAt: _lastChangedAt\n              });\n\n              return _this.MutationEvent.copyOf(m, function (draft) {\n                draft.data = JSON.stringify(newData);\n              });\n            });\n            return [4\n            /*yield*/\n            , storage.delete(this.MutationEvent, predicate)];\n\n          case 2:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , Promise.all(reconciledMutations.map(function (m) {\n              return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                  switch (_a.label) {\n                    case 0:\n                      return [4\n                      /*yield*/\n                      , storage.save(m, undefined, this.ownSymbol)];\n\n                    case 1:\n                      return [2\n                      /*return*/\n                      , _a.sent()];\n                  }\n                });\n              });\n            }))];\n\n          case 3:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  MutationEventOutbox.prototype.mergeUserFields = function (previous, current) {\n    var _a = JSON.parse(previous.data),\n        _version = _a._version,\n        _lastChangedAt = _a._lastChangedAt,\n        _deleted = _a._deleted,\n        previousData = __rest(_a, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n\n    var _b = JSON.parse(current.data),\n        __version = _b._version,\n        __lastChangedAt = _b._lastChangedAt,\n        __deleted = _b._deleted,\n        currentData = __rest(_b, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n\n    var data = JSON.stringify(__assign(__assign({\n      _version: _version,\n      _lastChangedAt: _lastChangedAt,\n      _deleted: _deleted\n    }, previousData), currentData));\n    return this.modelInstanceCreator(this.MutationEvent, __assign(__assign({}, current), {\n      data: data\n    }));\n  };\n  /*\n  if a model is using custom timestamp fields\n  the custom field names will be stored in the model attributes\n   e.g.\n  \"attributes\": [\n  {\n          \"type\": \"model\",\n          \"properties\": {\n              \"timestamps\": {\n                  \"createdAt\": \"createdOn\",\n                  \"updatedAt\": \"updatedOn\"\n              }\n          }\n  }\n  ]\n  */\n\n\n  MutationEventOutbox.prototype.removeTimestampFields = function (model, record) {\n    var _a, _b;\n\n    var CREATED_AT_DEFAULT_KEY = 'createdAt';\n    var UPDATED_AT_DEFAULT_KEY = 'updatedAt';\n    var createdTimestampKey = CREATED_AT_DEFAULT_KEY;\n    var updatedTimestampKey = UPDATED_AT_DEFAULT_KEY;\n    var modelAttributes = (_a = this.schema.namespaces[USER].models[model].attributes) === null || _a === void 0 ? void 0 : _a.find(function (attr) {\n      return attr.type === 'model';\n    });\n    var timestampFieldsMap = (_b = modelAttributes === null || modelAttributes === void 0 ? void 0 : modelAttributes.properties) === null || _b === void 0 ? void 0 : _b.timestamps;\n\n    if (timestampFieldsMap) {\n      createdTimestampKey = timestampFieldsMap[CREATED_AT_DEFAULT_KEY];\n      updatedTimestampKey = timestampFieldsMap[UPDATED_AT_DEFAULT_KEY];\n    }\n\n    delete record[createdTimestampKey];\n    delete record[updatedTimestampKey];\n    return record;\n  };\n\n  return MutationEventOutbox;\n}();\n\nexport { MutationEventOutbox };","map":{"version":3,"names":["__assign","__awaiter","__generator","__read","__rest","ModelPredicateCreator","QueryOne","USER","SYNC","valuesEqual","getIdentifierValue","TransformerMutationType","MutationEventOutbox","schema","MutationEvent","modelInstanceCreator","ownSymbol","prototype","enqueue","storage","mutationEvent","_this","_a","label","runExclusive","s","mutationEventModelDefinition","predicate","first","incomingMutationType","merged_1","incomingConditionJSON","incomingCondition","merged","_b","namespaces","models","createFromAST","and","modelId","eq","id","ne","inProgressMutationEventId","query","apply","sent","undefined","save","operation","CREATE","DELETE","delete","mergeUserFields","copyOf","draft","data","condition","JSON","parse","Object","keys","length","dequeue","record","recordOp","head","peek","syncOutboxVersionsOnDequeue","queryOne","FIRST","getForModel","model","userModelDefinition","mutationEvents","getModelIds","result","Set","forEach","add","_version","_lastChangedAt","_deleted","_incomingData","incomingData","__version","__lastChangedAt","__deleted","_outgoingData","outgoingData","recordId","outdatedMutations","reconciledMutations","removeTimestampFields","map","m","oldData","newData","stringify","Promise","all","previous","current","previousData","currentData","CREATED_AT_DEFAULT_KEY","UPDATED_AT_DEFAULT_KEY","createdTimestampKey","updatedTimestampKey","modelAttributes","attributes","find","attr","type","timestampFieldsMap","properties","timestamps"],"sources":["D:/aws-rekognition-liveness-detection-main/node_modules/@aws-amplify/datastore/lib-esm/sync/outbox.js"],"sourcesContent":["import { __assign, __awaiter, __generator, __read, __rest } from \"tslib\";\nimport { ModelPredicateCreator } from '../predicates';\nimport { QueryOne, } from '../types';\nimport { USER, SYNC, valuesEqual } from '../util';\nimport { getIdentifierValue, TransformerMutationType } from './utils';\n// TODO: Persist deleted ids\n// https://github.com/aws-amplify/amplify-js/blob/datastore-docs/packages/datastore/docs/sync-engine.md#outbox\nvar MutationEventOutbox = /** @class */ (function () {\n    function MutationEventOutbox(schema, MutationEvent, modelInstanceCreator, ownSymbol) {\n        this.schema = schema;\n        this.MutationEvent = MutationEvent;\n        this.modelInstanceCreator = modelInstanceCreator;\n        this.ownSymbol = ownSymbol;\n    }\n    MutationEventOutbox.prototype.enqueue = function (storage, mutationEvent) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, storage.runExclusive(function (s) { return __awaiter(_this, void 0, void 0, function () {\n                            var mutationEventModelDefinition, predicate, _a, first, incomingMutationType, merged_1, incomingConditionJSON, incomingCondition, merged;\n                            return __generator(this, function (_b) {\n                                switch (_b.label) {\n                                    case 0:\n                                        mutationEventModelDefinition = this.schema.namespaces[SYNC].models['MutationEvent'];\n                                        predicate = ModelPredicateCreator.createFromAST(mutationEventModelDefinition, {\n                                            and: [\n                                                { modelId: { eq: mutationEvent.modelId } },\n                                                { id: { ne: this.inProgressMutationEventId } },\n                                            ],\n                                        });\n                                        return [4 /*yield*/, s.query(this.MutationEvent, predicate)];\n                                    case 1:\n                                        _a = __read.apply(void 0, [_b.sent(), 1]), first = _a[0];\n                                        if (!(first === undefined)) return [3 /*break*/, 3];\n                                        return [4 /*yield*/, s.save(mutationEvent, undefined, this.ownSymbol)];\n                                    case 2:\n                                        _b.sent();\n                                        return [2 /*return*/];\n                                    case 3:\n                                        incomingMutationType = mutationEvent.operation;\n                                        if (!(first.operation === TransformerMutationType.CREATE)) return [3 /*break*/, 8];\n                                        if (!(incomingMutationType === TransformerMutationType.DELETE)) return [3 /*break*/, 5];\n                                        return [4 /*yield*/, s.delete(this.MutationEvent, predicate)];\n                                    case 4:\n                                        _b.sent();\n                                        return [3 /*break*/, 7];\n                                    case 5:\n                                        merged_1 = this.mergeUserFields(first, mutationEvent);\n                                        return [4 /*yield*/, s.save(this.MutationEvent.copyOf(first, function (draft) {\n                                                draft.data = merged_1.data;\n                                            }), undefined, this.ownSymbol)];\n                                    case 6:\n                                        _b.sent();\n                                        _b.label = 7;\n                                    case 7: return [3 /*break*/, 12];\n                                    case 8:\n                                        incomingConditionJSON = mutationEvent.condition;\n                                        incomingCondition = JSON.parse(incomingConditionJSON);\n                                        merged = void 0;\n                                        if (!(Object.keys(incomingCondition).length === 0)) return [3 /*break*/, 10];\n                                        merged = this.mergeUserFields(first, mutationEvent);\n                                        // delete all for model\n                                        return [4 /*yield*/, s.delete(this.MutationEvent, predicate)];\n                                    case 9:\n                                        // delete all for model\n                                        _b.sent();\n                                        _b.label = 10;\n                                    case 10:\n                                        merged = merged || mutationEvent;\n                                        // Enqueue new one\n                                        return [4 /*yield*/, s.save(merged, undefined, this.ownSymbol)];\n                                    case 11:\n                                        // Enqueue new one\n                                        _b.sent();\n                                        _b.label = 12;\n                                    case 12: return [2 /*return*/];\n                                }\n                            });\n                        }); })];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    MutationEventOutbox.prototype.dequeue = function (storage, record, recordOp) {\n        return __awaiter(this, void 0, void 0, function () {\n            var head;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.peek(storage)];\n                    case 1:\n                        head = _a.sent();\n                        if (!record) return [3 /*break*/, 3];\n                        return [4 /*yield*/, this.syncOutboxVersionsOnDequeue(storage, record, head, recordOp)];\n                    case 2:\n                        _a.sent();\n                        _a.label = 3;\n                    case 3: return [4 /*yield*/, storage.delete(head)];\n                    case 4:\n                        _a.sent();\n                        this.inProgressMutationEventId = undefined;\n                        return [2 /*return*/, head];\n                }\n            });\n        });\n    };\n    /**\n     * Doing a peek() implies that the mutation goes \"inProgress\"\n     *\n     * @param storage\n     */\n    MutationEventOutbox.prototype.peek = function (storage) {\n        return __awaiter(this, void 0, void 0, function () {\n            var head;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, storage.queryOne(this.MutationEvent, QueryOne.FIRST)];\n                    case 1:\n                        head = _a.sent();\n                        this.inProgressMutationEventId = head ? head.id : undefined;\n                        return [2 /*return*/, head];\n                }\n            });\n        });\n    };\n    MutationEventOutbox.prototype.getForModel = function (storage, model, userModelDefinition) {\n        return __awaiter(this, void 0, void 0, function () {\n            var mutationEventModelDefinition, modelId, mutationEvents;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        mutationEventModelDefinition = this.schema.namespaces[SYNC].models.MutationEvent;\n                        modelId = getIdentifierValue(userModelDefinition, model);\n                        return [4 /*yield*/, storage.query(this.MutationEvent, ModelPredicateCreator.createFromAST(mutationEventModelDefinition, {\n                                and: { modelId: { eq: modelId } },\n                            }))];\n                    case 1:\n                        mutationEvents = _a.sent();\n                        return [2 /*return*/, mutationEvents];\n                }\n            });\n        });\n    };\n    MutationEventOutbox.prototype.getModelIds = function (storage) {\n        return __awaiter(this, void 0, void 0, function () {\n            var mutationEvents, result;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, storage.query(this.MutationEvent)];\n                    case 1:\n                        mutationEvents = _a.sent();\n                        result = new Set();\n                        mutationEvents.forEach(function (_a) {\n                            var modelId = _a.modelId;\n                            return result.add(modelId);\n                        });\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    // applies _version from the AppSync mutation response to other items\n    // in the mutation queue with the same id\n    // see https://github.com/aws-amplify/amplify-js/pull/7354 for more details\n    MutationEventOutbox.prototype.syncOutboxVersionsOnDequeue = function (storage, record, head, recordOp) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _version, _lastChangedAt, _deleted, _incomingData, incomingData, data, __version, __lastChangedAt, __deleted, _outgoingData, outgoingData, mutationEventModelDefinition, userModelDefinition, recordId, predicate, outdatedMutations, reconciledMutations;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (head.operation !== recordOp) {\n                            return [2 /*return*/];\n                        }\n                        _version = record._version, _lastChangedAt = record._lastChangedAt, _deleted = record._deleted, _incomingData = __rest(record, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n                        incomingData = this.removeTimestampFields(head.model, _incomingData);\n                        data = JSON.parse(head.data);\n                        if (!data) {\n                            return [2 /*return*/];\n                        }\n                        __version = data._version, __lastChangedAt = data._lastChangedAt, __deleted = data._deleted, _outgoingData = __rest(data, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n                        outgoingData = this.removeTimestampFields(head.model, _outgoingData);\n                        // Don't sync the version when the data in the response does not match the data\n                        // in the request, i.e., when there's a handled conflict\n                        //\n                        // NOTE: `incomingData` contains all the fields in the record, and `outgoingData`\n                        // only contains updated fields, resulting in an error when doing a comparison\n                        // of two equal mutations. Fix this, or mitigate otherwise.\n                        if (!valuesEqual(incomingData, outgoingData, true)) {\n                            return [2 /*return*/];\n                        }\n                        mutationEventModelDefinition = this.schema.namespaces[SYNC].models['MutationEvent'];\n                        userModelDefinition = this.schema.namespaces['user'].models[head.model];\n                        recordId = getIdentifierValue(userModelDefinition, record);\n                        predicate = ModelPredicateCreator.createFromAST(mutationEventModelDefinition, {\n                            and: [\n                                { modelId: { eq: recordId } },\n                                { id: { ne: this.inProgressMutationEventId } },\n                            ],\n                        });\n                        return [4 /*yield*/, storage.query(this.MutationEvent, predicate)];\n                    case 1:\n                        outdatedMutations = _a.sent();\n                        if (!outdatedMutations.length) {\n                            return [2 /*return*/];\n                        }\n                        reconciledMutations = outdatedMutations.map(function (m) {\n                            var oldData = JSON.parse(m.data);\n                            var newData = __assign(__assign({}, oldData), { _version: _version, _lastChangedAt: _lastChangedAt });\n                            return _this.MutationEvent.copyOf(m, function (draft) {\n                                draft.data = JSON.stringify(newData);\n                            });\n                        });\n                        return [4 /*yield*/, storage.delete(this.MutationEvent, predicate)];\n                    case 2:\n                        _a.sent();\n                        return [4 /*yield*/, Promise.all(reconciledMutations.map(function (m) { return __awaiter(_this, void 0, void 0, function () { return __generator(this, function (_a) {\n                                switch (_a.label) {\n                                    case 0: return [4 /*yield*/, storage.save(m, undefined, this.ownSymbol)];\n                                    case 1: return [2 /*return*/, _a.sent()];\n                                }\n                            }); }); }))];\n                    case 3:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    MutationEventOutbox.prototype.mergeUserFields = function (previous, current) {\n        var _a = JSON.parse(previous.data), _version = _a._version, _lastChangedAt = _a._lastChangedAt, _deleted = _a._deleted, previousData = __rest(_a, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n        var _b = JSON.parse(current.data), __version = _b._version, __lastChangedAt = _b._lastChangedAt, __deleted = _b._deleted, currentData = __rest(_b, [\"_version\", \"_lastChangedAt\", \"_deleted\"]);\n        var data = JSON.stringify(__assign(__assign({ _version: _version,\n            _lastChangedAt: _lastChangedAt,\n            _deleted: _deleted }, previousData), currentData));\n        return this.modelInstanceCreator(this.MutationEvent, __assign(__assign({}, current), { data: data }));\n    };\n    /*\n    if a model is using custom timestamp fields\n    the custom field names will be stored in the model attributes\n\n    e.g.\n    \"attributes\": [\n    {\n            \"type\": \"model\",\n            \"properties\": {\n                \"timestamps\": {\n                    \"createdAt\": \"createdOn\",\n                    \"updatedAt\": \"updatedOn\"\n                }\n            }\n    }\n    ]\n    */\n    MutationEventOutbox.prototype.removeTimestampFields = function (model, record) {\n        var _a, _b;\n        var CREATED_AT_DEFAULT_KEY = 'createdAt';\n        var UPDATED_AT_DEFAULT_KEY = 'updatedAt';\n        var createdTimestampKey = CREATED_AT_DEFAULT_KEY;\n        var updatedTimestampKey = UPDATED_AT_DEFAULT_KEY;\n        var modelAttributes = (_a = this.schema.namespaces[USER].models[model].attributes) === null || _a === void 0 ? void 0 : _a.find(function (attr) { return attr.type === 'model'; });\n        var timestampFieldsMap = (_b = modelAttributes === null || modelAttributes === void 0 ? void 0 : modelAttributes.properties) === null || _b === void 0 ? void 0 : _b.timestamps;\n        if (timestampFieldsMap) {\n            createdTimestampKey = timestampFieldsMap[CREATED_AT_DEFAULT_KEY];\n            updatedTimestampKey = timestampFieldsMap[UPDATED_AT_DEFAULT_KEY];\n        }\n        delete record[createdTimestampKey];\n        delete record[updatedTimestampKey];\n        return record;\n    };\n    return MutationEventOutbox;\n}());\nexport { MutationEventOutbox };\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}