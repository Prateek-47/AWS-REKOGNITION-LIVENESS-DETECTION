{"ast":null,"code":"import { __awaiter as e, __asyncGenerator as i, __await as t } from \"tslib\";\nimport { Credentials as o, getAmplifyUserAgent as n } from \"@aws-amplify/core\";\nimport { AmazonAIInterpretPredictionsProvider as r } from \"@aws-amplify/predictions\";\nimport { RekognitionStreamingClient as s, StartFaceLivenessSessionCommand as d } from \"@aws-sdk/client-rekognitionstreaming\";\nimport { WebSocketFetchHandler as a } from \"@aws-sdk/middleware-websocket\";\nimport { VideoRecorder as l } from \"./videoRecorder.mjs\";\nimport { getLivenessUserAgent as h } from \"../../utils/platform.mjs\";\nconst c = process.env.NEXT_PUBLIC_STREAMING_API_URL,\n      m = 1e3;\n\nfunction v(e) {\n  return void 0 !== e.Challenge;\n}\n\nclass u extends r {\n  constructor(e, i, t, o) {\n    super(), this.sessionId = e, this.region = i, this._stream = t, this.videoEl = o, this.videoRecorder = new l(t), this.initPromise = this.init();\n  }\n\n  getResponseStream() {\n    return e(this, void 0, void 0, function* () {\n      return yield this.initPromise, this.responseStream;\n    });\n  }\n\n  startRecordingLivenessVideo() {\n    this.videoRecorder.start(1e3);\n  }\n\n  sendClientInfo(e) {\n    this.videoRecorder.dispatch(new MessageEvent(\"clientSesssionInfo\", {\n      data: {\n        clientInfo: e\n      }\n    }));\n  }\n\n  stopVideo() {\n    return e(this, void 0, void 0, function* () {\n      yield this.videoRecorder.stop();\n    });\n  }\n\n  dispatchStopVideoEvent() {\n    this.videoRecorder.dispatch(new Event(\"stopVideo\"));\n  }\n\n  endStream() {\n    return e(this, void 0, void 0, function* () {\n      if (\"recording\" === this.videoRecorder.getState() && (yield this.stopVideo(), this.dispatchStopVideoEvent()), this._reader) return yield this._reader.cancel(), this._reader.closed;\n    });\n  }\n\n  init() {\n    return e(this, void 0, void 0, function* () {\n      const e = yield o.get();\n      if (!e) throw new Error(\"No credentials\");\n      const i = {\n        credentials: e,\n        region: this.region,\n        customUserAgent: `${n()} ${h()}`,\n        requestHandler: new a({\n          connectionTimeout: 1e4\n        })\n      };\n      c && (i.endpointProvider = () => ({\n        url: new URL(c)\n      })), this._client = new s(i), this.responseStream = yield this.startLivenessVideoConnection();\n    });\n  }\n\n  getAsyncGeneratorFromReadableStream(e) {\n    const o = this;\n    return this._reader = e.getReader(), function () {\n      return i(this, arguments, function* () {\n        for (;;) {\n          const {\n            done: e,\n            value: i\n          } = yield t(o._reader.read());\n          if (e) return yield t(void 0);\n          if (\"stopVideo\" === i) yield yield t({\n            VideoEvent: {\n              VideoChunk: [],\n              TimestampMillis: Date.now()\n            }\n          });else if (void 0 !== i.arrayBuffer) {\n            const e = yield t(i.arrayBuffer()),\n                  o = new Uint8Array(e);\n            o.length > 0 && (yield yield t({\n              VideoEvent: {\n                VideoChunk: o,\n                TimestampMillis: Date.now()\n              }\n            }));\n          } else v(i) && (yield yield t({\n            ClientSessionInformationEvent: {\n              Challenge: i.Challenge\n            }\n          }));\n        }\n      });\n    };\n  }\n\n  startLivenessVideoConnection() {\n    return e(this, void 0, void 0, function* () {\n      const e = this.getAsyncGeneratorFromReadableStream(this.videoRecorder.videoStream)();\n      return (yield this._client.send(new d({\n        ChallengeVersions: \"FaceMovementAndLightChallenge_1.0.0\",\n        SessionId: this.sessionId,\n        LivenessRequestStream: e,\n        VideoWidth: this.videoEl.videoWidth.toString(),\n        VideoHeight: this.videoEl.videoHeight.toString()\n      }))).LivenessResponseStream;\n    });\n  }\n\n}\n\nexport { u as LivenessStreamProvider, m as TIME_SLICE };","map":{"version":3,"names":["__awaiter","e","__asyncGenerator","i","__await","t","Credentials","o","getAmplifyUserAgent","n","AmazonAIInterpretPredictionsProvider","r","RekognitionStreamingClient","s","StartFaceLivenessSessionCommand","d","WebSocketFetchHandler","a","VideoRecorder","l","getLivenessUserAgent","h","c","process","env","NEXT_PUBLIC_STREAMING_API_URL","m","v","Challenge","u","constructor","sessionId","region","_stream","videoEl","videoRecorder","initPromise","init","getResponseStream","responseStream","startRecordingLivenessVideo","start","sendClientInfo","dispatch","MessageEvent","data","clientInfo","stopVideo","stop","dispatchStopVideoEvent","Event","endStream","getState","_reader","cancel","closed","get","Error","credentials","customUserAgent","requestHandler","connectionTimeout","endpointProvider","url","URL","_client","startLivenessVideoConnection","getAsyncGeneratorFromReadableStream","getReader","arguments","done","value","read","VideoEvent","VideoChunk","TimestampMillis","Date","now","arrayBuffer","Uint8Array","length","ClientSessionInformationEvent","videoStream","send","ChallengeVersions","SessionId","LivenessRequestStream","VideoWidth","videoWidth","toString","VideoHeight","videoHeight","LivenessResponseStream","LivenessStreamProvider","TIME_SLICE"],"sources":["D:/aws-rekognition-liveness-detection-main/node_modules/@aws-amplify/ui-react-liveness/dist/esm/components/FaceLivenessDetector/service/utils/streamProvider.mjs"],"sourcesContent":["import{__awaiter as e,__asyncGenerator as i,__await as t}from\"tslib\";import{Credentials as o,getAmplifyUserAgent as n}from\"@aws-amplify/core\";import{AmazonAIInterpretPredictionsProvider as r}from\"@aws-amplify/predictions\";import{RekognitionStreamingClient as s,StartFaceLivenessSessionCommand as d}from\"@aws-sdk/client-rekognitionstreaming\";import{WebSocketFetchHandler as a}from\"@aws-sdk/middleware-websocket\";import{VideoRecorder as l}from\"./videoRecorder.mjs\";import{getLivenessUserAgent as h}from\"../../utils/platform.mjs\";const c=process.env.NEXT_PUBLIC_STREAMING_API_URL,m=1e3;function v(e){return void 0!==e.Challenge}class u extends r{constructor(e,i,t,o){super(),this.sessionId=e,this.region=i,this._stream=t,this.videoEl=o,this.videoRecorder=new l(t),this.initPromise=this.init()}getResponseStream(){return e(this,void 0,void 0,(function*(){return yield this.initPromise,this.responseStream}))}startRecordingLivenessVideo(){this.videoRecorder.start(1e3)}sendClientInfo(e){this.videoRecorder.dispatch(new MessageEvent(\"clientSesssionInfo\",{data:{clientInfo:e}}))}stopVideo(){return e(this,void 0,void 0,(function*(){yield this.videoRecorder.stop()}))}dispatchStopVideoEvent(){this.videoRecorder.dispatch(new Event(\"stopVideo\"))}endStream(){return e(this,void 0,void 0,(function*(){if(\"recording\"===this.videoRecorder.getState()&&(yield this.stopVideo(),this.dispatchStopVideoEvent()),this._reader)return yield this._reader.cancel(),this._reader.closed}))}init(){return e(this,void 0,void 0,(function*(){const e=yield o.get();if(!e)throw new Error(\"No credentials\");const i={credentials:e,region:this.region,customUserAgent:`${n()} ${h()}`,requestHandler:new a({connectionTimeout:1e4})};c&&(i.endpointProvider=()=>({url:new URL(c)})),this._client=new s(i),this.responseStream=yield this.startLivenessVideoConnection()}))}getAsyncGeneratorFromReadableStream(e){const o=this;return this._reader=e.getReader(),function(){return i(this,arguments,(function*(){for(;;){const{done:e,value:i}=yield t(o._reader.read());if(e)return yield t(void 0);if(\"stopVideo\"===i)yield yield t({VideoEvent:{VideoChunk:[],TimestampMillis:Date.now()}});else if(void 0!==i.arrayBuffer){const e=yield t(i.arrayBuffer()),o=new Uint8Array(e);o.length>0&&(yield yield t({VideoEvent:{VideoChunk:o,TimestampMillis:Date.now()}}))}else v(i)&&(yield yield t({ClientSessionInformationEvent:{Challenge:i.Challenge}}))}}))}}startLivenessVideoConnection(){return e(this,void 0,void 0,(function*(){const e=this.getAsyncGeneratorFromReadableStream(this.videoRecorder.videoStream)();return(yield this._client.send(new d({ChallengeVersions:\"FaceMovementAndLightChallenge_1.0.0\",SessionId:this.sessionId,LivenessRequestStream:e,VideoWidth:this.videoEl.videoWidth.toString(),VideoHeight:this.videoEl.videoHeight.toString()}))).LivenessResponseStream}))}}export{u as LivenessStreamProvider,m as TIME_SLICE};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}